name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      checks: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v2

    # Устанавливаем Node.js
    - uses: actions/setup-node@v2
      with:
        node-version: '18.x'

    # Установка зависимостей
    - name: Install dependencies
      run: npm ci

    # Установка Playwright с зависимостями
    - name: Install Playwright
      run: npx playwright install --with-deps

    # Запуск тестов Playwright
    - name: Run Playwright tests
      run: npx playwright test
      continue-on-error: true 

    # Генерация отчета Allure
    - name: Generate Allure Report
      if: always()
      run: npm run allure-report

    # Загружаем результаты тестов Playwright как артефакты
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-test-results
        # path: test-results/
        path: ./test-results

    # Загружаем результаты отчета Allure как артефакты
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-test-results
        # path: allure-report/
        path: ./allure-results

    # # Публикация отчета JUnit
    # - name: Publish JUnit Report
    #   uses: mikepenz/action-junit-report@v2
    #   if: always() 
    #   with:
    #     report_paths: 'junit-results/*.xml'

    # Получение истории Allure
    # - name: Get Allure history
    #   uses: actions/checkout@v2
    #   if: always()
    #   continue-on-error: true
    #   with:
    #     ref: gh-pages
    #     path: gh-pages

    # Действие для обновления отчета Allure из Marketplace
    # - name: Allure Report action from marketplace
    #   uses: simple-elf/allure-report-action@master
    #   if: always()
    #   with:
    #     allure_results: allure-results
    #     allure_history: allure-history
    #     keep_reports: 20

    # Публикация отчета на GitHub Pages
    # - name: Deploy report to Github Pages
    #   if: always()
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.ACCESS_TOKEN }}
    #     publish_branch: gh-pages
    #     publish_dir: allure-results


    - name: Deploy
      uses: peaceiris/actions-gh-pages@v4
      with:
        deploy_key: ${{ secrets.ACCESS_TOKEN }}
        # external_repository: username/external-repository
        publish_branch: gh-pages
        publish_dir: ./allure-results